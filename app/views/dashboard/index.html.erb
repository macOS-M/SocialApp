<% content_for :nav_offset, true %>
<div class="min-h-screen bg-indigo-50 p-6 sm:p-10">
  <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">

    <!-- Left column: Profile / stats -->
    <div class="md:col-span-1 bg-white rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-bold mb-4">Profile</h2>
      <p class="text-gray-700"><strong>Username:</strong> <%= @user.username %></p>
      <p class="text-gray-700"><strong>Email:</strong> <%= @user.email %></p>
      <p class="text-gray-700"><strong>Date of Birth:</strong> <%= @user.date_of_birth %></p>
      <%= link_to "Edit Profile", edit_user_registration_path, class: "mt-4 inline-block px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600" %>
    </div>

    <!-- Center column -->
    <div class="md:col-span-2 space-y-6">
      <h2 class="text-2xl font-bold mb-4">Your Feed</h2>

      <div class="bg-white p-4 rounded-2xl shadow space-y-3">
        <%= form_with(model: @post, authenticity_token: true, data: { turbo: false }, local: true, id: "dashboard-post-form", class: "space-y-4") do |f| %>
          <div>
            <%= f.label :content, "What's on your mind?", class: "block text-sm font-medium text-gray-700" %>
            <%= f.text_area :content, rows: 4, required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
            <% if @post.errors[:content].present? %>
              <p class="text-sm text-red-600 mt-1"><%= @post.errors[:content].first %></p>
            <% end %>
          </div>
        <% end %>
        <div class="flex justify-end">
          <button type="submit" form="dashboard-post-form" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            Post
          </button>
        </div>
      </div>

      <% @posts.each do |post| %>
        <div class="bg-white p-4 rounded-2xl shadow hover:shadow-md transition relative">
          <div class="flex items-center mb-3">
            <%= link_to profile_path(post.user.username), class: "font-semibold text-gray-900 hover:text-indigo-600 transition" do %>
              <%= post.user.username %>
            <% end %>
            <span class="text-gray-400 text-sm ml-2">â€¢ <%= time_ago_in_words(post.created_at) %> ago</span>
          </div>
          <p class="text-gray-800"><%= post.content %></p>

          <% if post.user == current_user %>
            <div class="absolute top-4 right-4 inline-block text-left" data-controller="dropdown">
              <button type="button" class="inline-flex justify-center w-8 h-8 rounded-full hover:bg-gray-200" data-action="click->dropdown#toggle">
                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z" />
                </svg>
              </button>

              <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-32 bg-white border rounded shadow-lg z-50">
                <%= link_to "Edit", edit_post_path(post), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                <%= link_to "Delete", post_path(post), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "block px-4 py-2 text-sm text-red-600 hover:bg-gray-100" %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if @posts.empty? %>
        <p class="text-gray-500">No posts yet. Start by creating one!</p>
      <% end %>
    </div>

    <!-- Right column -->
    <div class="md:col-span-1 space-y-6">

      <div class="bg-white rounded-2xl p-4 shadow-lg">
        <h2 class="text-xl font-bold mb-4">Friend Requests</h2>

        <% if @user.inverse_friendships.pending.any? %>
          <ul>
            <% @user.inverse_friendships.pending.each do |request| %>
              <li class="flex justify-between items-center mb-2">
                <span><%= request.user.username %> wants to be your friend</span>
                <div class="flex space-x-2">
                  <%= link_to "Accept", accept_friendship_path(request), data: { turbo_method: :patch }, class: "text-green-500 hover:underline" %>
                  <%= link_to "Reject", reject_friendship_path(request), data: { turbo_method: :patch }, class: "text-red-500 hover:underline" %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="text-gray-500">No pending requests</p>
        <% end %>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow-lg">
        <h2 class="text-xl font-bold mb-4">Friends</h2>

        <% if @user.friends.any? %>
          <ul>
            <% @user.friends.each do |friend| %>
              <li class="flex justify-between items-center mb-2">
                <%= link_to friend.username, profile_path(friend.username), class: "hover:text-indigo-600 transition" %>
                <%= link_to "Remove", friendship_path(friend), data: { turbo_method: :delete, turbo_confirm: "Remove friend?" }, class: "text-red-500 hover:underline" %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="text-gray-500">No friends yet. Add some!</p>
        <% end %>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow-lg">
        <h2 class="text-xl font-bold mb-4">Add Friends</h2>
        <% @users.each do |u| %>
          <% next if u == current_user %>
          <% next if @user.friends.include?(u) %>
          <% next if @user.pending_friends.include?(u) %>
          <% next if @user.incoming_pending_friends.include?(u) %>
          <div class="flex justify-between items-center mb-2">
            <%= link_to u.username, profile_path(u.username), class: "hover:text-indigo-600 transition" %>
            <%= link_to "Add Friend", friendships_path(friend_id: u.id), data: { turbo_method: :post }, class: "text-blue-500 hover:underline" %>
          </div>
        <% end %>
      </div>

    </div>

  </div>
</div>
